#Copyright (c) 2017, John Skinner
import sys
import bson.objectid
import config.global_configuration as global_conf
import database.client


def main(*args):
    """
    Compare a trial result to a reference trial result.
    This represents a basic task.
    Scripts to run this will be autogenerated by the job system
    The first argument is the comparison benchmark,
    the second argument is the id of the result to compare,
    and the third argument is the reference result id
    :return: 
    """
    if len(args) >= 3:
        benchmark_id = bson.objectid.ObjectId(args[0])
        comp_result_id = bson.objectid.ObjectId(args[1])
        ref_result_id = bson.objectid.ObjectId(args[2])

        config = global_conf.load_global_config('config.yml')
        db_client = database.client.DatabaseClient(config=config)

        s_benchmark = db_client.benchmarks_collection.find_one({'_id': benchmark_id})
        benchmark = db_client.deserialize_entity(s_benchmark)

        s_result = db_client.results_collection.find_one({'_id': comp_result_id})
        comp_result = db_client.deserialize_entity(s_result)

        s_result = db_client.results_collection.find_one({'_id': ref_result_id})
        ref_result = db_client.deserialize_entity(s_result)

        if benchmark.is_result_appropriate(comp_result) and benchmark.is_result_appropriate(ref_result):
            comparison_result = benchmark.compare_results(comp_result, ref_result)
            db_client.results_collection.insert(comparison_result.serialize())


if __name__ == '__main__':
    main(*sys.argv[1:])
